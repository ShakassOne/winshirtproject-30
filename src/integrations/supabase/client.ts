
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://uwgclposhhdovfjnazlp.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3Z2NscG9zaGhkb3Zmam5hemxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0OTA4MzEsImV4cCI6MjA2MTA2NjgzMX0.wZBdCERqRHdWQMCZvFSbJBSMoXQHvpK49Jz_m4dx4cc";

// Define our known database tables
// This helps TypeScript understand our database schema
export type Tables = {
  lotteries: {
    Row: {
      id: number;
      title: string;
      description: string | null;
      value: number;
      target_participants: number;
      current_participants: number;
      status: "active" | "completed" | "relaunched" | "cancelled";
      image: string | null;
      linked_products: number[] | null;
      end_date: string | null;
      draw_date: string | null;
      featured: boolean | null;
      created_at: string | null;
    };
    Insert: {
      id?: number;
      title: string;
      description?: string | null;
      value: number;
      target_participants?: number;
      current_participants?: number;
      status?: "active" | "completed" | "relaunched" | "cancelled";
      image?: string | null;
      linked_products?: number[] | null;
      end_date?: string | null;
      draw_date?: string | null;
      featured?: boolean | null;
      created_at?: string | null;
    };
    Update: {
      id?: number;
      title?: string;
      description?: string | null;
      value?: number;
      target_participants?: number;
      current_participants?: number;
      status?: "active" | "completed" | "relaunched" | "cancelled";
      image?: string | null;
      linked_products?: number[] | null;
      end_date?: string | null;
      draw_date?: string | null;
      featured?: boolean | null;
      created_at?: string | null;
    };
  };
  lottery_participants: {
    Row: {
      id: number;
      lottery_id: number;
      user_id: number;
      name: string | null;
      email: string | null;
      avatar: string | null;
      created_at: string | null;
    };
    Insert: {
      id?: number;
      lottery_id: number;
      user_id: number;
      name?: string | null;
      email?: string | null;
      avatar?: string | null;
      created_at?: string | null;
    };
    Update: {
      id?: number;
      lottery_id?: number;
      user_id?: number;
      name?: string | null;
      email?: string | null;
      avatar?: string | null;
      created_at?: string | null;
    };
  };
  lottery_winners: {
    Row: {
      id: number;
      lottery_id: number;
      user_id: number;
      name: string | null;
      email: string | null;
      avatar: string | null;
      drawn_at: string | null;
    };
    Insert: {
      id?: number;
      lottery_id: number;
      user_id: number;
      name?: string | null;
      email?: string | null;
      avatar?: string | null;
      drawn_at?: string | null;
    };
    Update: {
      id?: number;
      lottery_id?: number;
      user_id?: number;
      name?: string | null;
      email?: string | null;
      avatar?: string | null;
      drawn_at?: string | null;
    };
  };
  products: {
    Row: {
      id: number;
      name: string;
      description: string | null;
      price: number;
      image: string | null;
      secondary_image: string | null;
      sizes: string[] | null;
      colors: string[] | null;
      type: string | null;
      product_type: string | null;
      sleeve_type: string | null;
      linked_lotteries: number[] | null;
      popularity: number | null;
      tickets: number | null;
      weight: number | null;
      delivery_price: number | null;
      allow_customization: boolean | null;
      default_visual_id: number | null;
      default_visual_settings: any | null;
      visual_category_id: number | null;
      created_at: string | null;
    };
    Insert: {
      id?: number;
      name: string;
      description?: string | null;
      price: number;
      image?: string | null;
      secondary_image?: string | null;
      sizes?: string[] | null;
      colors?: string[] | null;
      type?: string | null;
      product_type?: string | null;
      sleeve_type?: string | null;
      linked_lotteries?: number[] | null;
      popularity?: number | null;
      tickets?: number | null;
      weight?: number | null;
      delivery_price?: number | null;
      allow_customization?: boolean | null;
      default_visual_id?: number | null;
      default_visual_settings?: any | null;
      visual_category_id?: number | null;
      created_at?: string | null;
    };
    Update: {
      id?: number;
      name?: string;
      description?: string | null;
      price?: number;
      image?: string | null;
      secondary_image?: string | null;
      sizes?: string[] | null;
      colors?: string[] | null;
      type?: string | null;
      product_type?: string | null;
      sleeve_type?: string | null;
      linked_lotteries?: number[] | null;
      popularity?: number | null;
      tickets?: number | null;
      weight?: number | null;
      delivery_price?: number | null;
      allow_customization?: boolean | null;
      default_visual_id?: number | null;
      default_visual_settings?: any | null;
      visual_category_id?: number | null;
      created_at?: string | null;
    };
  };
  orders: {
    Row: {
      id: number;
      user_id: number | null;
      status: string | null;
      total: number;
      shipping_address: any | null;
      shipping_method: string | null;
      shipping_cost: number | null;
      payment_method: string | null;
      payment_status: string | null;
      created_at: string | null;
      updated_at: string | null;
    };
    Insert: {
      id?: number;
      user_id?: number | null;
      status?: string | null;
      total: number;
      shipping_address?: any | null;
      shipping_method?: string | null;
      shipping_cost?: number | null;
      payment_method?: string | null;
      payment_status?: string | null;
      created_at?: string | null;
      updated_at?: string | null;
    };
    Update: {
      id?: number;
      user_id?: number | null;
      status?: string | null;
      total?: number;
      shipping_address?: any | null;
      shipping_method?: string | null;
      shipping_cost?: number | null;
      payment_method?: string | null;
      payment_status?: string | null;
      created_at?: string | null;
      updated_at?: string | null;
    };
  };
  order_items: {
    Row: {
      id: number;
      order_id: number;
      product_id: number;
      quantity: number;
      price: number;
      customization: any | null;
      created_at: string | null;
    };
    Insert: {
      id?: number;
      order_id: number;
      product_id: number;
      quantity?: number;
      price: number;
      customization?: any | null;
      created_at?: string | null;
    };
    Update: {
      id?: number;
      order_id?: number;
      product_id?: number;
      quantity?: number;
      price?: number;
      customization?: any | null;
      created_at?: string | null;
    };
  };
  clients: {
    Row: {
      id: number;
      user_id: string | null;
      name: string | null;
      email: string | null;
      phone: string | null;
      address: any | null;
      created_at: string | null;
      updated_at: string | null;
    };
    Insert: {
      id?: number;
      user_id?: string | null;
      name?: string | null;
      email?: string | null;
      phone?: string | null;
      address?: any | null;
      created_at?: string | null;
      updated_at?: string | null;
    };
    Update: {
      id?: number;
      user_id?: string | null;
      name?: string | null;
      email?: string | null;
      phone?: string | null;
      address?: any | null;
      created_at?: string | null;
      updated_at?: string | null;
    };
  };
  visuals: {
    Row: {
      id: number;
      name: string;
      description: string | null;
      image_url: string;
      category_id: number | null;
      tags: string[] | null;
      created_at: string | null;
    };
    Insert: {
      id?: number;
      name: string;
      description?: string | null;
      image_url: string;
      category_id?: number | null;
      tags?: string[] | null;
      created_at?: string | null;
    };
    Update: {
      id?: number;
      name?: string;
      description?: string | null;
      image_url?: string;
      category_id?: number | null;
      tags?: string[] | null;
      created_at?: string | null;
    };
  };
  pg_tables: {
    Row: {
      schemaname: string | null;
      tablename: string | null;
      tableowner: string | null;
      tablespace: string | null;
      hasindexes: boolean | null;
      hasrules: boolean | null;
      hastriggers: boolean | null;
      rowsecurity: boolean | null;
    };
    Insert: {
      schemaname?: string | null;
      tablename?: string | null;
      tableowner?: string | null;
      tablespace?: string | null;
      hasindexes?: boolean | null;
      hasrules?: boolean | null;
      hastriggers?: boolean | null;
      rowsecurity?: boolean | null;
    };
    Update: {
      schemaname?: string | null;
      tablename?: string | null;
      tableowner?: string | null;
      tablespace?: string | null;
      hasindexes?: boolean | null;
      hasrules?: boolean | null;
      hastriggers?: boolean | null;
      rowsecurity?: boolean | null;
    };
  };
};

// This adds the necessary type information to the Database type
// so Supabase client knows about our tables
export type CustomDatabase = {
  public: {
    Tables: Tables;
    Views: {};
    Functions: {};
    Enums: {};
    CompositeTypes: {};
  };
};

// Export the requiredTables list
export const requiredTables = [
  'lotteries', 
  'lottery_participants', 
  'lottery_winners', 
  'products',
  'visuals',
  'orders',
  'order_items', 
  'clients'
] as const;

// Define the valid table names type
export type ValidTableName = typeof requiredTables[number];

// Create a custom supabase client with our type definitions
export const supabase = createClient<CustomDatabase>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

// Function to check if Supabase connection works
export const checkSupabaseConnection = async (): Promise<boolean> => {
  try {
    const { data, error } = await supabase
      .from('pg_tables')
      .select('tablename')
      .limit(1);
    
    return !error;
  } catch (e) {
    console.error("Error checking Supabase connection:", e);
    return false;
  }
};

// Function to check if all required tables exist
export const checkRequiredTables = async (): Promise<{exists: boolean; missing: readonly string[]}> => {
  try {
    const { data } = await supabase
      .from('pg_tables')
      .select('tablename')
      .eq('schemaname', 'public');
    
    if (!data) return { exists: false, missing: requiredTables };
    
    const existingTables = data.map(t => t.tablename);
    const missingTables = requiredTables.filter(
      table => !existingTables.includes(table)
    );
    
    return {
      exists: missingTables.length === 0,
      missing: missingTables
    };
  } catch (e) {
    console.error("Error checking required tables:", e);
    return { exists: false, missing: requiredTables };
  }
};

// Function to sync local data to Supabase
export const syncLocalDataToSupabase = async (tableName: ValidTableName): Promise<boolean> => {
  try {
    const localData = localStorage.getItem(tableName);
    if (!localData) return false;
    
    const parsedData = JSON.parse(localData);
    if (!Array.isArray(parsedData) || parsedData.length === 0) return false;
    
    // Clear existing data
    const { error: deleteError } = await supabase
      .from(tableName)
      .delete()
      .neq('id', 0);
    
    if (deleteError) {
      console.error(`Error clearing ${tableName} table:`, deleteError);
      return false;
    }
    
    // Insert new data
    const { error: insertError } = await supabase
      .from(tableName)
      .insert(parsedData);
    
    if (insertError) {
      console.error(`Error inserting data to ${tableName}:`, insertError);
      return false;
    }
    
    return true;
  } catch (e) {
    console.error(`Error syncing ${tableName}:`, e);
    return false;
  }
};
